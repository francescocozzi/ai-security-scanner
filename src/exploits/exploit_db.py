'''
Exploit DB Integration
Search and link public exploits
'''

import requests
import time


class ExploitDBClient:
    '''Client for Exploit-DB API'''
    
    def __init__(self):
        '''Initialize Exploit-DB client'''
        self.base_url = 'https://www.exploit-db.com/search'
        self.api_url = 'https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv'
        self.exploits_cache = None
        self.last_update = 0
    
    def search_by_cve(self, cve_id):
        '''Search exploits for CVE'''
        try:
            # Simple web search (ExploitDB doesn't have official API)
            search_url = f"https://www.exploit-db.com/search?cve={cve_id}"
            
            result = {
                'cve_id': cve_id,
                'search_url': search_url,
                'has_exploit': 'Unknown',  # Requires web scraping
                'exploitdb_url': search_url
            }
            
            return result
            
        except Exception as e:
            print(f"âš  Error searching ExploitDB: {e}")
            return None
    
    def analyze_exploitability(self, vuln_data):
        '''Analyze if vulnerability has public exploit'''
        cve_id = vuln_data.get('cve_id')
        
        if not cve_id:
            return None
        
        exploit_info = self.search_by_cve(cve_id)
        
        # Heuristic: CVSS + Attack Vector
        cvss = vuln_data.get('cvss_score', 0)
        av = vuln_data.get('attack_vector', 'LOCAL')
        
        exploitability_score = 0
        
        if cvss >= 9.0:
            exploitability_score += 40
        elif cvss >= 7.0:
            exploitability_score += 30
        elif cvss >= 4.0:
            exploitability_score += 20
        
        if av == 'NETWORK':
            exploitability_score += 40
        elif av == 'ADJACENT':
            exploitability_score += 30
        elif av == 'LOCAL':
            exploitability_score += 20
        
        # Complexity
        ac = vuln_data.get('attack_complexity', 'HIGH')
        if ac == 'LOW':
            exploitability_score += 20
        
        return {
            'cve_id': cve_id,
            'exploitability_score': min(100, exploitability_score),
            'exploitdb_search': exploit_info['search_url'] if exploit_info else None,
            'assessment': self._get_assessment(exploitability_score)
        }
    
    def _get_assessment(self, score):
        '''Get exploitability assessment'''
        if score >= 80:
            return 'ðŸ”´ CRITICAL - Highly likely public exploits exist'
        elif score >= 60:
            return 'ðŸŸ  HIGH - Probable public exploitation'
        elif score >= 40:
            return 'ðŸŸ¡ MEDIUM - Possible exploitation'
        else:
            return 'ðŸŸ¢ LOW - Unlikely public exploits'


# Quick function
def check_exploit(cve_id):
    '''Quick exploit check'''
    client = ExploitDBClient()
    return client.search_by_cve(cve_id)


if __name__ == '__main__':
    print("="*60)
    print("EXPLOIT DB CLIENT TEST")
    print("="*60)
    
    client = ExploitDBClient()
    
    # Test famous vulnerabilities
    test_cves = [
        'CVE-2021-44228',  # Log4Shell
        'CVE-2017-0144',   # EternalBlue
        'CVE-2014-0160',   # Heartbleed
    ]
    
    for cve in test_cves:
        print(f"\n{cve}:")
        result = client.search_by_cve(cve)
        print(f"  Search: {result['search_url']}")
    
    print("\n" + "="*60)
